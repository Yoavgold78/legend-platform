services:
  # Shell - Next.js Frontend (Story 1.2)
  - type: web
    name: shell
    env: node
    buildCommand: npm install --include=dev && npm run build --workspace=apps/shell
    startCommand: cd apps/shell && npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: AUTH0_SECRET
        generateValue: true
      - key: AUTH0_BASE_URL
        value: https://legend-shell-staging.onrender.com
      - key: AUTH0_ISSUER_BASE_URL
        sync: false
      - key: AUTH0_CLIENT_ID
        sync: false
      - key: AUTH0_CLIENT_SECRET
        sync: false
      - key: AUTH0_AUDIENCE
        value: https://api.legend-platform.com
      - key: NEXT_PUBLIC_AUDITS_FE_URL
        sync: false  # Set to audits-fe URL after Story 1.4
    healthCheckPath: /

  # API Gateway - Central Token Validation (Story 1.3)
  - type: web
    name: api-gateway
    env: node
    buildCommand: npm install
    startCommand: cd apps/api-gateway && node src/server.js
    envVars:
      - key: AUTH0_AUDIENCE
        value: https://api.legend-platform.com
      - key: AUTH0_ISSUER_BASE_URL
        sync: false  # Set manually in Render dashboard
      - key: AUDITS_BE_URL
        sync: false  # Will be set to Private Service URL after Story 1.4
      - key: SCHEDULE_BE_URL
        sync: false  # Will be set to Private Service URL after Story 1.5
      - key: NODE_ENV
        value: production
      - key: ALLOWED_ORIGINS
        sync: false  # Set to Shell production URL
    healthCheckPath: /api/v1/health

  # AuditsApp Backend - Private Service (Story 1.4)
  - type: pserv
    name: audits-be
    env: node
    buildCommand: npm install && cd apps/audits-be && npm install --arch=x64 --platform=linux sharp
    startCommand: cd apps/audits-be && node index.js
    envVars:
      - key: MONGO_URI
        sync: false  # Set manually in Render dashboard - MongoDB Atlas connection string
      - key: CLOUDINARY_CLOUD_NAME
        sync: false  # Cloudinary configuration
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 5000

  # AuditsApp Frontend - Web Service (Story 1.4)
  - type: web
    name: audits-fe
    env: node
    buildCommand: npm install --include=dev && npm run build --workspace=apps/audits-fe
    startCommand: cd apps/audits-fe && npm start
    envVars:
      - key: AUTH0_SECRET
        generateValue: true
      - key: AUTH0_BASE_URL
        sync: false  # Set to audits-fe URL
      - key: AUTH0_ISSUER_BASE_URL
        sync: false  # Same Auth0 tenant as Shell
      - key: AUTH0_CLIENT_ID
        sync: false  # Can be same or different Auth0 app
      - key: AUTH0_CLIENT_SECRET
        sync: false
      - key: NEXT_PUBLIC_API_URL
        sync: false  # Set to API Gateway URL
    healthCheckPath: /

  # Placeholder for schedule-be (Story 1.5)
  # - type: pserv
  #   name: schedule-be
  #   env: node
  #   buildCommand: npm install
  #   startCommand: node apps/schedule-be/src/server.js
