<?xml version="1.0" encoding="UTF-8"?>
<story-context id="story-1-4-auditsapp-nextjs-be-integration" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.4</storyId>
    <title>AuditsApp (Next.js + BE) Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>DOCS/stories/1-4-auditsapp-nextjs-be-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps Engineer</asA>
    <iWant>to migrate the existing AuditsApp (Frontend &amp; Backend) into the Monorepo and route its traffic through the API Gateway</iWant>
    <soThat>it becomes the first application fully integrated into the unified platform</soThat>
    <tasks>
      <task id="1" ac="4.1">Migrate AuditsApp Backend to Monorepo - Create apps/audits-be/ directory structure, copy existing code, configure package.json with workspace dependencies, install Express/Mongoose/Cloudinary dependencies</task>
      <task id="2" ac="4.2,4.3">Refactor audits-be Authentication - Remove Auth0 SDK dependencies, create trustGateway.js middleware to extract x-user-id header, update routes to use new middleware, verify User model has auth0Id field</task>
      <task id="3" ac="4.4">Configure audits-be as Private Service - Update render.yaml with pserv configuration, set environment variables (MONGO_URI, CLOUDINARY_*), configure build and start commands</task>
      <task id="4" ac="4.5,4.6">Connect Gateway to audits-be - Deploy audits-be to Render Staging, set AUDITS_BE_URL in Gateway, restart Gateway, verify proxy routing works</task>
      <task id="5" ac="4.7">Migrate AuditsApp Frontend to Shell - Create apps/shell/app/(main)/audits/ directory, copy pages and components, update API client to use Gateway URLs, update imports to use shared components</task>
      <task id="6" ac="4.8">Update Shell Navigation - Add "Audits" link to apps/shell/app/(main)/layout.tsx with AssignmentIcon, ensure visibility when authenticated</task>
      <task id="7" ac="4.9">End-to-End Integration Testing - Unit test trustGateway middleware, integration test audit routes, manual E2E test full login-to-audits flow, test error scenarios</task>
      <task id="8" ac="4.1-4.9">Update Documentation and Deploy - Update READMEs, commit changes, deploy to Render Staging, run E2E tests, document rollback plan</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC4.1">AuditsApp Backend code migrated to apps/audits-be/ with complete directory structure (controllers, models, routes, middleware, config, package.json)</criterion>
    <criterion id="AC4.2">audits-be authentication middleware refactored: Remove all Auth0 JWT validation logic, create trustGateway.js middleware extracting x-user-id header to req.user.auth0_sub, all routes use trustGateway middleware, return 401 if x-user-id missing</criterion>
    <criterion id="AC4.3">audits-be MongoDB User queries use auth0Id field (verify existing model has this field per architecture)</criterion>
    <criterion id="AC4.4">audits-be configured as Private Service in render.yaml: Type pserv, not publicly accessible, environment variables MONGO_URI/NODE_ENV/CLOUDINARY_* (no Auth0 vars)</criterion>
    <criterion id="AC4.5">API Gateway AUDITS_BE_URL environment variable set to audits-be internal Private Service URL</criterion>
    <criterion id="AC4.6">Gateway proxy route /api/v1/audits/* successfully routes to audits-be (verify proxy.js from Story 1-3 works with actual backend)</criterion>
    <criterion id="AC4.7">AuditsApp Frontend code migrated to apps/shell/app/(main)/audits/: All page components, audit-specific components, API client updated to call Gateway URLs (/api/v1/audits/*)</criterion>
    <criterion id="AC4.8">Shell navigation updated to include "Audits" link in shared nav (visible when user authenticated)</criterion>
    <criterion id="AC4.9">End-to-end flow works: User logs in, clicks Audits, page loads and makes API call to /api/v1/audits/my-audits with Bearer token, Gateway validates and proxies with x-user-id header, audits-be trusts header and queries MongoDB by auth0Id, frontend displays audits list</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact path="DOCS/brownfield-architecture.md" title="Brownfield Architecture" section="Section 3: Tech Stack">
        AuditsApp uses Node.js + Express + Mongoose + MongoDB, already uses Auth0 but validates directly (needs refactoring to trust Gateway)
      </artifact>
      <artifact path="DOCS/brownfield-architecture.md" title="Brownfield Architecture" section="Section 5: Component Architecture">
        audits-be communicates with MongoDB and Cloudinary, assumes authentication handled by Gateway. Backends are Private Services accessible only from Gateway.
      </artifact>
      <artifact path="DOCS/brownfield-architecture.md" title="Brownfield Architecture" section="Section 7: Source Tree Integration">
        Frontend integrates natively into Shell at app/(main)/audits/, Backend at apps/audits-be/ with controllers/models/routes structure
      </artifact>
      <artifact path="DOCS/brownfield-architecture.md" title="Brownfield Architecture" section="Section 11: Security Integration">
        Backends trust x-user-id header from Gateway (only Gateway validates Auth0 tokens). Gateway is single authentication point. Backends deployed as Private Services not publicly accessible.
      </artifact>
      <artifact path="DOCS/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Detailed Design - Services">
        audits-be responsibility: all business logic for Audits &amp; Checklists, communicates with MongoDB/Cloudinary, assumes Gateway authentication. Does NOT validate tokens directly.
      </artifact>
      <artifact path="DOCS/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Data Models - User Model">
        MongoDB User schema must have auth0Id field with unique: true, index: true, sparse: true. This field links user identity from Auth0.
      </artifact>
      <artifact path="DOCS/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="APIs - Backend Contracts">
        Backends expect x-user-id header from Gateway containing auth0_sub. Request headers must include x-user-id (string) from authenticated user.
      </artifact>
      <artifact path="DOCS/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Workflows - User Login Flow">
        Shell → Gateway (validates token) → audits-be (trusts x-user-id header) → MongoDB query by auth0Id → returns user's audits
      </artifact>
      <artifact path="DOCS/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Test Strategy Summary">
        Unit tests (Vitest) for trustGateway middleware and user lookup logic. Integration tests for audit routes with mocked Gateway headers. E2E tests (Playwright) for full login → navigate to Audits → view audits flow.
      </artifact>
      <artifact path="DOCS/PRD.md" title="Product Requirements Document" section="Story 1.4">
        AuditsApp Frontend migrated to apps/shell under /app/(main)/audits/. Backend migrated to apps/audits-be. Backend configured as Private Service. Gateway routes /api/v1/audits/* to audits-be. Backend refactored to trust x-user-id header. User can navigate to Audits and perform operations after login.
      </artifact>
      <artifact path="DOCS/stories/1-3-api-gateway-central-token-validation.md" title="Story 1-3: API Gateway" section="Dev Agent Record">
        Gateway proxy route /api/v1/audits/* already configured with conditional setup (returns 503 when AUDITS_BE_URL not set). Gateway adds x-user-id header (from token sub claim) and x-request-id (correlation ID) to all proxied requests. Private Service URLs format: https://service-name.onrender.com (not public).
      </artifact>
    </docs>

    <code>
      <artifact path="apps/api-gateway/src/middleware/addUserContext.js" kind="middleware" symbol="addUserContext" lines="1-14" reason="Pattern for extracting user ID from JWT and adding x-user-id header - REUSE this pattern in audits-be trustGateway middleware">
        Extracts auth0_sub from validated token (req.auth.payload.sub) and adds to req.headers['x-user-id']. Also stores in req.userId for logging. This is the Gateway's implementation - audits-be should expect to receive this header.
      </artifact>
      <artifact path="apps/api-gateway/src/routes/proxy.js" kind="route" symbol="router" lines="1-75" reason="Gateway proxy configuration for /api/v1/audits/* route - already configured, just needs AUDITS_BE_URL set">
        Conditionally creates proxy middleware if AUDITS_BE_URL is set. Rewrites path from /api/v1/audits to root. Adds x-request-id header. Logs requests and responses. Returns 503 if backend URL not configured. Error handling returns 502 if backend unavailable.
      </artifact>
      <artifact path="apps/api-gateway/src/middleware/auth.js" kind="middleware" symbol="jwtCheck" lines="1-29" reason="Auth0 JWT validation middleware - DO NOT replicate in audits-be, Gateway handles this">
        Uses express-oauth2-jwt-bearer to validate Auth0 JWTs. Validates signature (RS256), issuer, audience, expiration. Returns 401 for invalid tokens. Lazy initialization pattern to handle environment variable loading. audits-be should NOT have this - only Gateway validates tokens.
      </artifact>
      <artifact path="render.yaml" kind="config" symbol="services" lines="1-50" reason="Render deployment configuration - needs audits-be Private Service added">
        Defines Shell (web service) and API Gateway (web service). Has placeholder comment for audits-be (pserv). Service type must be 'pserv' for Private Service. Needs build command, start command, environment variables.
      </artifact>
      <artifact path="package.json" kind="config" symbol="workspaces" lines="1-15" reason="Monorepo npm workspaces configuration - audits-be will be included in apps/*">
        Defines workspaces: apps/* and packages/*. Scripts run across all workspaces. audits-be package.json can reference workspace packages with 'workspace:*' notation.
      </artifact>
      <artifact path="apps/shell/app/(main)/layout.tsx" kind="component" symbol="layout" reason="Shared navigation layout - needs 'Audits' link added">
        Main layout for authenticated routes. Contains shared navigation component. Need to add navigation item for Audits with href='/audits' and AssignmentIcon from @mui/icons-material.
      </artifact>
      <artifact path="apps/audits-be/package.json" kind="config" symbol="dependencies" reason="Existing audits-be package.json - verify dependencies and add workspace references">
        Current package.json exists but needs verification. Should include Express, Mongoose, Cloudinary SDK. Should reference @legend/types as workspace dependency. Should NOT include Auth0 SDKs after refactoring.
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="express" version="^4.19.0" scope="audits-be">Web server framework</package>
        <package name="mongoose" version="^8.x" scope="audits-be">MongoDB ODM</package>
        <package name="cloudinary" version="^2.x" scope="audits-be">Image storage SDK</package>
        <package name="cors" version="^2.8.5" scope="audits-be">CORS middleware</package>
        <package name="http-proxy-middleware" version="^3.0.0" scope="api-gateway">Proxy routing (already installed)</package>
        <package name="@legend/types" version="workspace:*" scope="audits-be">Shared TypeScript types</package>
        <package name="@auth0/nextjs-auth0" version="^3.5.0" scope="shell">Auth0 SDK for Next.js (already installed)</package>
        <package name="@mui/material" version="^5.15.0" scope="shell">Material UI components</package>
        <package name="@mui/icons-material" version="^5.15.0" scope="shell">Material UI icons (for AssignmentIcon)</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>audits-be MUST NOT validate Auth0 tokens directly - Gateway handles all token validation. Backend only trusts x-user-id header.</constraint>
    <constraint>audits-be MUST be configured as Private Service (pserv in render.yaml) - not publicly accessible, only Gateway can reach it.</constraint>
    <constraint>Frontend MUST call Gateway URLs (/api/v1/audits/*) NOT direct backend URLs. API client should use relative URLs.</constraint>
    <constraint>User identity linked via auth0Id field in MongoDB - must match x-user-id from Gateway. User model must have auth0Id unique indexed.</constraint>
    <constraint>Cloudinary integration remains in audits-be - no changes to image upload logic needed.</constraint>
    <constraint>Follow coding standards: Use ES Modules (import/export) not CommonJS (require). TypeScript for frontend. ESLint/Prettier from packages/config.</constraint>
    <constraint>Testing required: Unit tests for trustGateway middleware, integration tests for routes, E2E test for full flow.</constraint>
    <constraint>Path rewriting in Gateway proxy: /api/v1/audits/* becomes root path (/) on backend. Verify pathRewrite config in proxy.js.</constraint>
    <constraint>Environment variables: audits-be needs MONGO_URI, NODE_ENV, CLOUDINARY_* but NO Auth0 credentials (AUTH0_AUDIENCE, AUTH0_ISSUER removed).</constraint>
    <constraint>Error handling: audits-be should return proper HTTP status codes (401, 404, 500) - Gateway will proxy them to Shell.</constraint>
  </constraints>

  <interfaces>
    <interface name="Gateway to audits-be Request Headers" kind="HTTP headers" signature="x-user-id: string, x-request-id: string" path="apps/api-gateway/src/routes/proxy.js">
      Gateway adds x-user-id header containing auth0_sub from validated JWT. Gateway adds x-request-id header for request correlation. Backend MUST extract x-user-id to identify user.
    </interface>
    <interface name="trustGateway Middleware" kind="Express middleware" signature="function trustGateway(req, res, next)" path="apps/audits-be/middleware/trustGateway.js">
      Extracts x-user-id header from request. If missing, returns 401 with error message. If present, attaches to req.user = { auth0_sub: x-user-id }. Logs user ID. Calls next() to continue middleware chain.
    </interface>
    <interface name="MongoDB User Lookup" kind="Mongoose query" signature="User.findOne({ auth0Id: string })" path="apps/audits-be/models/User.js">
      Query user by auth0Id field which matches x-user-id from Gateway. User model must have auth0Id field with unique: true, index: true, sparse: true.
    </interface>
    <interface name="Audits API Endpoint" kind="REST API" signature="GET /api/v1/audits/my-audits" path="apps/api-gateway (proxies to audits-be)">
      Frontend calls Gateway at /api/v1/audits/my-audits with Authorization Bearer token. Gateway validates token, adds x-user-id header, proxies to audits-be. Backend queries user's audits by auth0Id. Returns JSON array of audits.
    </interface>
    <interface name="Shell Auth0 Token" kind="React Hook" signature="const { getAccessTokenSilently } = useAuth0()" path="apps/shell (from @auth0/nextjs-auth0)">
      Frontend uses Auth0 hook to get access token. Token passed in Authorization: Bearer header to all API calls. Token validated by Gateway, not backend.
    </interface>
    <interface name="Shell Navigation Link" kind="React Component" signature="{ label: string, href: string, icon: ComponentType }" path="apps/shell/app/(main)/layout.tsx">
      Navigation items array in layout. Add: { label: 'Audits', href: '/audits', icon: AssignmentIcon }. Link only visible when user authenticated (check useAuth0 isAuthenticated).
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for unit and integration tests. Test files colocated with source (e.g., trustGateway.test.js next to trustGateway.js). Use Playwright for E2E tests in tests/e2e/ directory. Follow AAA pattern (Arrange, Act, Assert). Mock external dependencies (MongoDB, Cloudinary) in unit tests. Use supertest for API route integration tests.
    </standards>
    <locations>
      apps/audits-be/middleware/*.test.js
      apps/audits-be/routes/*.test.js
      apps/audits-be/controllers/*.test.js
      apps/shell/app/(main)/audits/**/*.test.tsx
      tests/e2e/audits.spec.ts
    </locations>
    <ideas>
      <idea ac="AC4.2">Unit test trustGateway middleware: (1) Request with x-user-id header → req.user.auth0_sub populated, (2) Request without x-user-id → 401 error with message</idea>
      <idea ac="AC4.3">Integration test user lookup: Mock MongoDB, query User.findOne({ auth0Id }), verify correct user returned</idea>
      <idea ac="AC4.9">E2E test full flow: (1) Login to Shell with test Auth0 user, (2) Click Audits navigation, (3) Verify page loads and API call made, (4) Verify audits data displayed</idea>
      <idea ac="AC4.6">Integration test Gateway proxy: Mock audits-be backend, send request to /api/v1/audits/test with valid token, verify proxied with x-user-id header</idea>
      <idea ac="AC4.7">Component test audits frontend: Render audits list page, mock API responses, verify audits displayed correctly</idea>
      <idea ac="AC4.9">Manual test error scenarios: (1) Gateway down → error message, (2) audits-be down → 502 error handled, (3) Invalid token → 401 redirects to login</idea>
    </ideas>
  </tests>
</story-context>
